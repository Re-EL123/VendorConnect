<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Street Link — Feed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="/firebase.js"></script>
</head>
<body class="bg-gray-100">
  <div class="max-w-4xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold mb-4">Street Link Feed</h1>

    <div class="mb-4">
      <label for="provinceFilter" class="block text-sm font-medium text-gray-700">Filter by Province</label>
      <select id="provinceFilter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
        <option value="">All Provinces</option>
        <option value="Gauteng">Gauteng</option>
        <option value="Western Cape">Western Cape</option>
        <option value="KwaZulu-Natal">KwaZulu-Natal</option>
        <option value="Eastern Cape">Eastern Cape</option>
        <!-- Add more provinces as needed -->
      </select>
    </div>

    <div id="feed">
      <!-- Skeleton loaders -->
      <div id="skeleton" class="space-y-4">
        <div class="p-4 bg-white rounded shadow animate-pulse">
          <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
          <div class="h-3 bg-gray-200 rounded w-1/2"></div>
        </div>
        <div class="p-4 bg-white rounded shadow animate-pulse">
          <div class="h-4 bg-gray-300 rounded w-2/3 mb-2"></div>
          <div class="h-3 bg-gray-200 rounded w-1/3"></div>
        </div>
      </div>
    </div>

    <div class="flex justify-between mt-6">
      <button id="prevPage" class="bg-gray-200 px-4 py-2 rounded">Previous</button>
      <button id="nextPage" class="bg-gray-200 px-4 py-2 rounded">Next</button>
    </div>
  </div>

  <script>
    const feedContainer = document.getElementById('feed');
    const skeleton = document.getElementById('skeleton');
    const provinceFilter = document.getElementById('provinceFilter');

    let lastVisible = null;
    let firstVisible = null;
    let queryLimit = 5;
    let currentQuery = null;

    firebase.auth().onAuthStateChanged((user) => {
      if (!user) return window.location.href = 'login.html';
      loadPosts();
    });

    provinceFilter.addEventListener('change', loadPosts);

    function loadPosts(direction = 'initial') {
      feedContainer.innerHTML = '';
      skeleton.style.display = 'block';

      let ref = firebase.firestore().collection('posts');

      const province = provinceFilter.value;
      if (province) ref = ref.where('province', '==', province);
      ref = ref.orderBy('timestamp', 'desc');

      if (direction === 'next' && lastVisible) ref = ref.startAfter(lastVisible);
      if (direction === 'prev' && firstVisible) ref = ref.endBefore(firstVisible);

      ref.limit(queryLimit).get().then(snapshot => {
        skeleton.style.display = 'none';

        if (snapshot.empty) {
          feedContainer.innerHTML = '<p class="text-gray-500">No posts found.</p>';
          return;
        }

        firstVisible = snapshot.docs[0];
        lastVisible = snapshot.docs[snapshot.docs.length - 1];

        snapshot.forEach(doc => {
          const post = doc.data();
          const postEl = document.createElement('div');
          postEl.className = 'bg-white p-4 rounded shadow mb-4';

          let imageHtml = '';
          if (post.imageUrl) {
            imageHtml = `<img loading="lazy" src="${post.imageUrl}" class="w-full rounded mb-2" alt="Post Image">`;
          }

          postEl.innerHTML = `
            <h2 class="text-xl font-semibold">${post.title || 'Untitled Post'}</h2>
            ${imageHtml}
            <p class="text-sm text-gray-600 mt-1">${new Date(post.timestamp?.toDate?.() || post.timestamp).toLocaleString()}</p>
            <div class="mt-2 flex items-center space-x-4">
              <button onclick="likePost('${doc.id}')" class="text-blue-600">❤️ Like</button>
              <span id="like-count-${doc.id}" class="text-gray-700 text-sm">0 likes</span>
              <a href="view-post.html?id=${doc.id}" class="text-green-600">View Post</a>
            </div>
          `;

          feedContainer.appendChild(postEl);

          // Load like count
          firebase.firestore().collection('posts').doc(doc.id).collection('likes').get().then(likeSnap => {
            document.getElementById(`like-count-${doc.id}`).textContent = `${likeSnap.size} likes`;
          });
        });
      });
    }

    function likePost(postId) {
      const user = firebase.auth().currentUser;
      if (!user) return;

      const likeRef = firebase.firestore().collection('posts').doc(postId).collection('likes').doc(user.uid);
      likeRef.set({ liked: true });
    }

    document.getElementById('nextPage').addEventListener('click', () => loadPosts('next'));
    document.getElementById('prevPage').addEventListener('click', () => loadPosts('prev'));
  </script>
</body>
</html>
