<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Street Link ‚Äî Feed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Navigation Bar -->
  <nav class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
    <h1 class="text-xl font-bold text-gray-800">Street Link</h1>
    <div class="space-x-3">
      <button id="dashboardBtn" class="text-sm text-blue-600 hover:underline">Dashboard</button>
      <a href="inbox.html" class="text-sm text-blue-600 hover:underline">Inbox</a>
      <a href="settings.html" class="text-sm text-blue-600 hover:underline">Settings</a>
    </div>
  </nav>

  <!-- Filters & Sort -->
  <div class="max-w-4xl mx-auto px-4 mt-4">
    <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
      <select id="provinceFilter" class="border rounded px-3 py-1">
        <option value="all">All Provinces</option>
        <option value="Gauteng">Gauteng</option>
        <option value="Western Cape">Western Cape</option>
        <option value="KwaZulu-Natal">KwaZulu-Natal</option>
        <option value="Eastern Cape">Eastern Cape</option>
        <!-- Add more provinces -->
      </select>

      <select id="cityFilter" class="border rounded px-3 py-1">
        <option value="all">All Cities</option>
        <option value="Cape Town">Cape Town</option>
        <option value="Durban">Durban</option>
        <option value="Johannesburg">Johannesburg</option>
        <!-- Add more cities -->
      </select>

      <select id="sortFilter" class="border rounded px-3 py-1">
        <option value="timestamp">Newest</option>
        <option value="likes">Most Liked</option>
        <option value="views">Most Viewed</option>
      </select>
    </div>

    <!-- Posts Container -->
    <div id="postsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

    <!-- Pagination -->
    <div class="flex justify-between items-center mt-4">
      <button id="prevBtn" class="bg-gray-300 px-3 py-1 rounded disabled:opacity-50" disabled>Previous</button>
      <button id="nextBtn" class="bg-gray-300 px-3 py-1 rounded disabled:opacity-50" disabled>Next</button>
    </div>
  </div>

  <!-- Post Upload Button -->
  <div id="postBtnWrapper" class="fixed bottom-5 right-5 hidden">
    <a href="post-upload.html" class="bg-blue-600 text-white px-4 py-2 rounded shadow-md">+ New Post</a>
  </div>

  <script>
    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDEsYzVYNvSsKvgFk5cSa_7lWWdJtDc1gs",
      authDomain: "online-mall-4422.firebaseapp.com",
      databaseURL: "https://online-mall-4422-default-rtdb.firebaseio.com",
      projectId: "online-mall-4422",
      storageBucket: "online-mall-4422.appspot.com",
      messagingSenderId: "947082232783",
      appId: "1:947082232783:web:116206502e5fb38383c8ba",
      measurementId: "G-LNTNZQBGL8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Elements
    const postsContainer = document.getElementById("postsContainer");
    const provinceFilter = document.getElementById("provinceFilter");
    const cityFilter = document.getElementById("cityFilter");
    const sortFilter = document.getElementById("sortFilter");
    const postBtnWrapper = document.getElementById("postBtnWrapper");
    const dashboardBtn = document.getElementById("dashboardBtn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    let allPosts = [];
    let currentUser = null;
    let currentPage = 1;
    const pageSize = 6;

    // Utility: fetch average rating for a vendor
    async function getAvgRating(vendorId) {
      const snapshot = await db.collection("ratings").where("vendorId", "==", vendorId).get();
      if (snapshot.empty) return 0;
      let total = 0;
      snapshot.forEach(doc => total += doc.data().rating);
      return (total / snapshot.size).toFixed(1);
    }

    // Utility: check if current user liked a post
    async function hasUserLiked(postId, userId) {
      if (!userId) return false;
      const doc = await db.collection("posts").doc(postId)
        .collection("likes").doc(userId).get();
      return doc.exists;
    }

    // Utility: check if user follows vendor
    async function isFollowing(vendorId, userId) {
      if (!userId) return false;
      const doc = await db.collection("follows").doc(`${userId}_${vendorId}`).get();
      return doc.exists;
    }

    // Render posts with all info
    async function renderPosts() {
      const province = provinceFilter.value;
      const city = cityFilter.value;
      const sortKey = sortFilter.value;

      // Filter posts client-side for province/city (can be optimized for large datasets)
      let filtered = allPosts.filter(post => {
        if (province !== "all" && post.province !== province) return false;
        if (city !== "all" && post.city !== city) return false;
        return true;
      });

      // Sort posts
      filtered.sort((a, b) => (b[sortKey] || 0) - (a[sortKey] || 0));

      // Pagination
      const totalPages = Math.ceil(filtered.length / pageSize);
      if(currentPage > totalPages) currentPage = totalPages || 1;

      const start = (currentPage - 1) * pageSize;
      const pagePosts = filtered.slice(start, start + pageSize);

      // Enable/disable pagination buttons
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;

      // Render post cards async with vendor info, ratings, like & follow status
      postsContainer.innerHTML = "";
      for (const post of pagePosts) {
        // Get vendor info
        const vendorDoc = await db.collection("users").doc(post.vendorId).get();
        const vendor = vendorDoc.data() || {};
        const avgRating = await getAvgRating(post.vendorId);
        const liked = await hasUserLiked(post.id, currentUser.uid);
        const following = await isFollowing(post.vendorId, currentUser.uid);

        // Vendor badge HTML
        const vendorBadge = vendor.accountType === "vendor" ? 
          `<span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded ml-2">Vendor</span>` : "";

        // Like button disabled if liked already
        const likeBtnClass = liked ? "bg-gray-300 cursor-not-allowed" : "bg-red-500 hover:bg-red-600";

        // Follow button text toggle
        const followText = following ? "Following" : "Follow";

        // Post image (optional)
        const postImgHtml = post.imageUrl ? 
          `<img src="${post.imageUrl}" alt="Post image" class="w-full h-40 object-cover rounded mb-2">` : "";

        // Create post card
        const postCard = document.createElement("div");
        postCard.className = "bg-white p-4 rounded shadow";

        postCard.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <h3 class="text-lg font-semibold">${post.title}</h3>
            <div>
              <span class="text-sm text-yellow-600 font-semibold">‚≠ê ${avgRating}</span>
              ${vendorBadge}
            </div>
          </div>
          ${postImgHtml}
          <p class="text-gray-700 mb-2">${post.description || post.content || ""}</p>
          <p class="text-xs text-gray-500 mb-2">
            By <strong>${vendor.businessName || vendor.fullName || "Vendor"}</strong> ‚Äî 
            ${vendor.city || "Unknown City"}, ${vendor.province || "Unknown Province"}
          </p>
          <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
            <span>üëÅÔ∏è ${post.views || 0} Views</span>
            <span>‚ù§Ô∏è ${post.likes || 0} Likes</span>
          </div>
          <div class="flex gap-2">
            <button 
              class="like-btn text-white px-3 py-1 rounded ${likeBtnClass}" 
              data-postid="${post.id}" ${liked ? "disabled" : ""}>
              ‚ù§Ô∏è ${liked ? "Liked" : "Like"}
            </button>
            <button 
              class="follow-btn text-white px-3 py-1 rounded bg-green-600 hover:bg-green-700"
              data-vendorid="${post.vendorId}">
              ${followText}
            </button>
            <a href="view-post.html?id=${post.id}" class="text-blue-600 underline px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">View</a>
          </div>
        `;

        postsContainer.appendChild(postCard);
      }
    }

    // Load all posts and cache in allPosts
    function loadPosts() {
      db.collection("posts")
        .orderBy("timestamp", "desc")
        .onSnapshot(snapshot => {
          allPosts = [];
          snapshot.forEach(doc => {
            allPosts.push({ id: doc.id, ...doc.data() });
          });
          renderPosts();
        });
    }

    // Like post handler
    async function likePost(postId, btn) {
      if (!currentUser) return alert("Please login to like posts.");

      const likeRef = db.collection("posts").doc(postId).collection("likes").doc(currentUser.uid);
      const likeDoc = await likeRef.get();
      if (likeDoc.exists) return alert("You already liked this post.");

      // Add like subdoc
      await likeRef.set({ likedAt: firebase.firestore.FieldValue.serverTimestamp() });

      // Increment like count
      await db.collection("posts").doc(postId).update({
        likes: firebase.firestore.FieldValue.increment(1)
      });

      btn.disabled = true;
      btn.textContent = "‚ù§Ô∏è Liked";
      btn.classList.remove("bg-red-500", "hover:bg-red-600");
      btn.classList.add("bg-gray-300", "cursor-not-allowed");
    }

    // Follow vendor handler
    async function followVendor(vendorId, btn) {
      if (!currentUser) return alert("Please login to follow vendors.");

      const followRef = db.collection("follows").doc(`${currentUser.uid}_${vendorId}`);
      const followDoc = await followRef.get();

      if (followDoc.exists) {
        // Unfollow
        await followRef.delete();
        btn.textContent = "Follow";
        btn.classList.remove("bg-gray-700");
        btn.classList.add("bg-green-600", "hover:bg-green-700");
      } else {
        // Follow
        await followRef.set({
          userId: currentUser.uid,
          vendorId,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        btn.textContent = "Following";
        btn.classList.remove("bg-green-600", "hover:bg-green-700");
        btn.classList.add("bg-gray-700");
      }
    }

    // Auth state observer
    auth.onAuthStateChanged(async user => {
      currentUser = user;
      if (!user) {
        location.href = "login.html";
        return;
      }

      // Show post upload button if vendor
      const userDoc = await db.collection("users").doc(user.uid).get();
      const userData = userDoc.data();
      if (userData && userData.accountType === "vendor") {
        postBtnWrapper.classList.remove("hidden");
        dashboardBtn.onclick = () => location.href = "vendor-dashboard.html";
      } else {
        dashboardBtn.onclick = () => location.href = "dashboard.html";
      }

      loadPosts();
    });

    // Filters event listeners
    provinceFilter.addEventListener("change", () => { currentPage = 1; renderPosts(); });
    cityFilter.addEventListener("change", () => { currentPage = 1; renderPosts(); });
    sortFilter.addEventListener("change", () => { currentPage = 1; renderPosts(); });
    prevBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderPosts();
      }
    });
    nextBtn.addEventListener("click", () => {
      const totalPages = Math.ceil(allPosts.length / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        renderPosts();
      }
    });

    // Delegate click events on posts container (like, follow buttons)
    postsContainer.addEventListener("click", e => {
      if (e.target.classList.contains("like-btn")) {
        const postId = e.target.dataset.postid;
        likePost(postId, e.target);
      } else if (e.target.classList.contains("follow-btn")) {
        const vendorId = e.target.dataset.vendorid;
        followVendor(vendorId, e.target);
      }
    });
  </script>
</body>
</html>
