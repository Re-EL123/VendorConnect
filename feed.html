<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Street Link Feed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <nav class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Street Link</h1>
    <div>
      <button id="dashboardBtn" class="px-4 py-2 bg-blue-600 text-white rounded mr-2">Dashboard</button>
      <button onclick="location.href='inbox.html'" class="px-4 py-2 bg-gray-600 text-white rounded mr-2">Inbox</button>
      <button onclick="location.href='settings.html'" class="px-4 py-2 bg-gray-600 text-white rounded">Settings</button>
    </div>
  </nav>

  <div class="p-4">
    <div class="flex flex-wrap gap-4 mb-4">
      <select id="provinceFilter" class="p-2 border rounded">
        <option value="">All Provinces</option>
      </select>
      <select id="cityFilter" class="p-2 border rounded">
        <option value="">All Cities</option>
      </select>
      <select id="sortBy" class="p-2 border rounded">
        <option value="timestamp">Latest</option>
        <option value="likes">Most Liked</option>
        <option value="views">Most Viewed</option>
      </select>
    </div>

    <div id="uploadBtnContainer" class="mb-4 hidden">
      <button onclick="location.href='upload-post.html'" class="bg-green-600 text-white px-4 py-2 rounded">Upload Post</button>
    </div>

    <div id="postsContainer" class="grid md:grid-cols-3 gap-4"></div>

    <div class="flex justify-center mt-6">
      <button id="loadMoreBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Load More</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDEsYzVYNvSsKvgFk5cSa_7lWWdJtDc1gs",
      authDomain: "online-mall-4422.firebaseapp.com",
      databaseURL: "https://online-mall-4422-default-rtdb.firebaseio.com",
      projectId: "online-mall-4422",
      storageBucket: "online-mall-4422.appspot.com",
      messagingSenderId: "947082232783",
      appId: "1:947082232783:web:116206502e5fb38383c8ba",
      measurementId: "G-LNTNZQBGL8"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let postsData = [];
    let postsPerPage = 6;
    let currentPage = 1;

    auth.onAuthStateChanged(async user => {
      if (!user) return (location.href = 'login.html');
      currentUser = user;
      const doc = await db.collection('users').doc(user.uid).get();
      const data = doc.data();
      if (data.accountType === 'vendor') {
        document.getElementById('uploadBtnContainer').classList.remove('hidden');
        document.getElementById('dashboardBtn').onclick = () => location.href = 'vendor-dashboard.html';
      } else {
        document.getElementById('dashboardBtn').onclick = () => location.href = 'dashboard.html';
      }
      fetchAndDisplayPosts();
    });

    async function fetchAndDisplayPosts() {
      const snapshot = await db.collection('posts').orderBy('timestamp', 'desc').get();
      postsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      populateFilters();
      renderPosts();
    }

    function populateFilters() {
      const provinces = new Set();
      const cities = new Set();
      postsData.forEach(post => {
        if (post.province) provinces.add(post.province);
        if (post.city) cities.add(post.city);
      });
      const provinceFilter = document.getElementById('provinceFilter');
      const cityFilter = document.getElementById('cityFilter');

      provinces.forEach(p => {
        provinceFilter.innerHTML += `<option value="${p}">${p}</option>`;
      });
      cities.forEach(c => {
        cityFilter.innerHTML += `<option value="${c}">${c}</option>`;
      });
    }

    function renderPosts() {
      const container = document.getElementById('postsContainer');
      container.innerHTML = '';
      let filtered = postsData;
      const province = document.getElementById('provinceFilter').value;
      const city = document.getElementById('cityFilter').value;
      const sortBy = document.getElementById('sortBy').value;

      if (province) filtered = filtered.filter(p => p.province === province);
      if (city) filtered = filtered.filter(p => p.city === city);
      filtered.sort((a, b) => (b[sortBy] || 0) - (a[sortBy] || 0));

      const start = (currentPage - 1) * postsPerPage;
      const pagePosts = filtered.slice(start, start + postsPerPage);

      pagePosts.forEach(post => {
        const image = post.imageUrl ? `<img data-src="${post.imageUrl}" alt="Post image" class="lazy w-full h-48 object-cover rounded" />` : '';
        container.innerHTML += `
          <div class="bg-white p-4 rounded shadow">
            <h2 class="text-lg font-bold">${post.title || 'Untitled Post'}</h2>
            ${image}
            <p class="mt-2">${post.description || ''}</p>
            <div class="flex justify-between mt-2 text-sm">
              <span>${post.city || ''}, ${post.province || ''}</span>
              <span>‚ù§Ô∏è ${post.likes || 0} üëÅÔ∏è ${post.views || 0}</span>
            </div>
            <button onclick="location.href='view-post.html?id=${post.id}'" class="mt-2 text-blue-600 underline">View</button>
          </div>
        `;
      });

      lazyLoadImages();
    }

    function lazyLoadImages() {
      const lazyImages = document.querySelectorAll('img.lazy');
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            img.src = img.dataset.src;
            img.classList.remove('lazy');
            observer.unobserve(img);
          }
        });
      });
      lazyImages.forEach(img => observer.observe(img));
    }

    document.getElementById('provinceFilter').addEventListener('change', () => { currentPage = 1; renderPosts(); });
    document.getElementById('cityFilter').addEventListener('change', () => { currentPage = 1; renderPosts(); });
    document.getElementById('sortBy').addEventListener('change', () => { currentPage = 1; renderPosts(); });
    document.getElementById('loadMoreBtn').addEventListener('click', () => { currentPage++; renderPosts(); });
  </script>
</body>
</html>
