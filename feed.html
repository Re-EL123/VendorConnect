<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Streetâ€‘ConnectÂ Mzansi â€¢ Feed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .skeleton {
      animation: pulse 1.5s infinite;
      background-color: #e2e8f0;
      height: 12rem;
      border-radius: 0.75rem;
    }
    @keyframes pulse {
      0%,100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .ripple {
      position: relative;
      overflow: hidden;
    }
    .ripple::after {
      content: '';
      position: absolute;
      width: 5px; height: 5px;
      background: rgba(0,0,0,0.2);
      border-radius: 50%;
      transform: scale(1);
      opacity: 0;
      pointer-events: none;
      animation: ripple-effect 0.6s linear;
    }
    @keyframes ripple-effect {
      to { transform: scale(100); opacity: 0; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="p-4 flex justify-between items-center bg-white shadow">
    <h1 class="text-xl font-bold">Streetâ€‘ConnectÂ Mzansi</h1>
    <nav class="flex gap-4 items-center">
      <button id="exploreBtn" class="text-blue-600 hover:underline">ğŸ” Explore</button>
      <button id="dashboardBtn" class="text-blue-600 hover:underline">ğŸ“Š Dashboard</button>
      <button id="notificationsBtn" class="text-blue-600 hover:underline">ğŸ”” Notifications</button>
      <button id="settingsBtn" class="text-blue-600 hover:underline">âš™ï¸ Settings</button>
    </nav>
  </header>

  <!-- MAIN CONTENT -->
  <section class="p-4 max-w-3xl mx-auto flex flex-col flex-grow">

    <!-- Post Upload (business users) -->
    <form id="postUploadForm" class="mb-8 bg-white p-4 rounded shadow hidden" enctype="multipart/form-data">
      <h2 class="text-lg font-semibold mb-3">Upload a New Post</h2>
      <!-- fields: title, description, image, province, city -->
      <!-- omitted for brevity: identical to your implementation -->
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 ripple">Upload</button>
    </form>

    <!-- Infinite scroll posts container -->
    <div id="postsContainer" class="grid grid-cols-1 gap-6"></div>

    <!-- Loading more -->
    <div id="loader" class="py-4 text-center text-gray-500 hidden">Loading more posts...</div>
  </section>

  <!-- IMAGE MODAL -->
  <div id="imgModal" class="fixed inset-0 bg-black/70 flex justify-center items-center hidden">
    <img id="modalImg" src="" class="max-h-[90%] max-w-[90%] rounded-lg shadow-lg" />
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, limit, startAfter,
      onSnapshot, doc, getDoc, setDoc, updateDoc, addDoc,
      serverTimestamp, increment, where
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const app = initializeApp({ /* your config */ });
    const db = getFirestore(app), auth = getAuth(app), storage = getStorage(app);

    let currentUser, userData, lastVisible = null;
    const postsContainer = document.getElementById('postsContainer');
    const loader = document.getElementById('loader');
    const imgModal = document.getElementById('imgModal');
    const modalImg = document.getElementById('modalImg');

    onAuthStateChanged(auth, async u => {
      if (!u) return window.location.href = 'login.html';
      currentUser = u;
      const ud = await getDoc(doc(db,'users',u.uid));
      userData = ud.exists() ? ud.data() : {};
      if (['pro','business'].includes(userData.accountType)) {
        document.getElementById('postUploadForm').classList.remove('hidden');
      }
      setupNav();
      initFeed();
    });

    function setupNav(){
      document.getElementById('exploreBtn').onclick = () => window.location.reload();
      document.getElementById('dashboardBtn').onclick = () => {
        const t = userData.accountType;
        window.location.href = (t==='pro'||t==='business')?'vendor-dashboard.html':'dashboard.html';
      };
      document.getElementById('notificationsBtn').onclick = () => window.location.href = 'notifications.html';
      document.getElementById('settingsBtn').onclick = () => window.location.href = 'settings.html';
    }

    // Initialize feed with real-time listener + infinite scroll
    function initFeed(){
      const q = query(collection(db,'posts'), orderBy('createdAt','desc'), limit(5));
      onSnapshot(q, snap => {
        postsContainer.innerHTML = '';
        snap.docs.forEach(docSnap=>createPostCard(docSnap, true));
        lastVisible = snap.docs[snap.docs.length-1];
      });
      window.addEventListener('scroll', ()=> {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 300) loadMore();
      });
    }

    async function loadMore(){
      if (!lastVisible) return;
      if (loader.classList.contains('hidden')) loader.classList.remove('hidden');
      const fq = query(collection(db,'posts'),
        orderBy('createdAt','desc'), startAfter(lastVisible), limit(5));
      const snap = await (await getFirestore(app).getDocs(fq));
      snap.forEach(docSnap=>createPostCard(docSnap));
      lastVisible = snap.docs[snap.docs.length-1];
      loader.classList.add('hidden');
    }

    async function createPostCard(docSnap, prepend=false){
      const post = docSnap.data(), id = docSnap.id;
      const ud = await getDoc(doc(db,'users',post.uid));
      const poster = ud.exists()? ud.data() : {};
      const card = document.createElement('div');
      card.className = 'bg-white p-4 rounded-xl shadow ripple';
      card.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-3 cursor-pointer">
            <img src="${poster.profilePhotoURL||'https://via.placeholder.com/48'}" class="w-10 h-10 rounded-full"/>
            <span class="font-semibold text-gray-800 business-name">${poster.businessName||poster.fullName||'Unknown'}</span>
          </div>
          <button class="overflow-menu text-gray-500 text-xl">â‹¯</button>
        </div>
        <h2 class="text-lg font-bold">${post.title}</h2>
        <p class="text-sm text-gray-600 mb-2">${post.description}</p>
        ${post.imageURL?`<img src="${post.imageURL}" class="img-thumb rounded-lg w-full max-h-80 object-cover cursor-pointer transition-transform hover:scale-105"/>`:''}
        <div class="flex gap-4 mt-3">
          <button class="like-btn text-red-500">â¤ï¸ <span id="like-${id}">${post.likes||0}</span></button>
          <button class="follow-btn text-green-500"></button>
          <button class="save-btn text-blue-500">ğŸ’¾ Save</button>
        </div>
        <div class="mt-2">
          <form data-id="${id}" class="comment-form flex gap-2">
            <input type="text" name="comment" placeholder="Write a comment..." class="flex-grow border rounded p-1"/>
            <button class="text-blue-600">Post</button>
          </form>
        </div>`;
      if (prepend) postsContainer.prepend(card);
      else postsContainer.appendChild(card);

      // Event Listeners
      card.querySelector('.business-name').onclick = ()=>window.location.href=`chat.html?vendor=${post.uid}`;
      card.querySelector('.overflow-menu').onclick = e=>{
        const m = document.createElement('div');
        m.className = 'absolute bg-white shadow rounded p-2';
        m.innerHTML = `<button class="block px-4 py-2 view-vendor">View Vendor</button>`;
        document.body.appendChild(m);
        m.style.top = e.clientY+'px';
        m.style.left = e.clientX+'px';
        m.querySelector('.view-vendor').onclick = ()=>location.href=`vendor-view.html?vendor=${post.uid}`;
        document.addEventListener('click',()=>m.remove(),{once:true});
      };
      if (post.imageURL) card.querySelector('.img-thumb').onclick = ()=>{
        modalImg.src = post.imageURL;
        imgModal.classList.remove('hidden');
      };
      imgModal.onclick = ()=>imgModal.classList.add('hidden');

      // Likes
      card.querySelector('.like-btn').onclick = async ()=>{
        const likeDoc = doc(db,'likes',`${currentUser.uid}_${id}`);
        if ((await getDoc(likeDoc)).exists()) return;
        await setDoc(likeDoc,{uid:currentUser.uid,postId:id,timestamp:serverTimestamp()});
        await updateDoc(doc(db,'posts',id),{likes:increment(1)});
        card.querySelector(`#like-${id}`).textContent = +card.querySelector(`#like-${id}`).textContent + 1;
      };

      // Follow toggle
      const followBtn = card.querySelector('.follow-btn');
      const follDoc = doc(db,'follows',`${currentUser.uid}_${post.uid}`);
      const follSnap = await getDoc(follDoc);
      followBtn.textContent = follSnap.exists()? 'Unfollow' : 'Follow';
      followBtn.onclick = async ()=>{
        if ((await getDoc(follDoc)).exists()) {
          await updateDoc(follDoc,{}); // delete if logic desired
          followBtn.textContent = 'Follow';
        } else {
          await setDoc(follDoc,{uid:currentUser.uid,vendorId:post.uid,timestamp:serverTimestamp()});
          followBtn.textContent = 'Unfollow';
        }
      };

      // Comments
      card.querySelector('.comment-form').onsubmit = async e=>{
        e.preventDefault();
        const ctext = e.target.comment.value.trim();
        if (!ctext) return;
        await addDoc(collection(db,'comments'),{
          postId:id,uid:currentUser.uid,text:ctext,timestamp:serverTimestamp()
        });
        e.target.reset();
      };
    }
  </script>
</body>
</html>
