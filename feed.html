<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Street Link ‚Äî Feed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Navigation Bar -->
  <nav class="flex justify-between items-center bg-white shadow p-4">
    <h1 class="text-xl font-bold text-blue-600">Street Link</h1>
    <div class="space-x-3">
      <button id="dashboardBtn" class="text-sm font-medium text-blue-600 hover:underline">Dashboard</button>
      <button onclick="location.href='inbox.html'" class="text-sm font-medium text-blue-600 hover:underline">Inbox</button>
      <button onclick="location.href='settings.html'" class="text-sm font-medium text-blue-600 hover:underline">Settings</button>
    </div>
  </nav>

  <!-- Vendor Post Button -->
  <div id="postBtnContainer" class="p-4 hidden">
    <button onclick="location.href='upload-post.html'" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700">
      Create a Post
    </button>
  </div>

  <!-- Filters -->
  <div class="p-4 flex flex-wrap gap-4 items-center">
    <select id="cityFilter" class="border rounded px-2 py-1">
      <option value="">All Cities</option>
      <option value="Cape Town">Cape Town</option>
      <option value="Johannesburg">Johannesburg</option>
      <option value="Durban">Durban</option>
      <option value="Pretoria">Pretoria</option>
    </select>

    <select id="sortFilter" class="border rounded px-2 py-1">
      <option value="timestamp">Newest</option>
      <option value="likes">Most Liked</option>
      <option value="views">Most Viewed</option>
    </select>
  </div>

  <!-- Feed -->
  <div id="feed" class="p-4 space-y-4"></div>

  <!-- Pagination -->
  <div class="flex justify-center items-center my-4">
    <button id="prevPage" class="mx-2 px-3 py-1 border rounded bg-white hover:bg-gray-100">Previous</button>
    <span id="pageInfo" class="text-sm text-gray-600"></span>
    <button id="nextPage" class="mx-2 px-3 py-1 border rounded bg-white hover:bg-gray-100">Next</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDEsYzVYNvSsKvgFk5cSa_7lWWdJtDc1gs",
      authDomain: "online-mall-4422.firebaseapp.com",
      databaseURL: "https://online-mall-4422-default-rtdb.firebaseio.com",
      projectId: "online-mall-4422",
      storageBucket: "online-mall-4422.appspot.com",
      messagingSenderId: "947082232783",
      appId: "1:947082232783:web:116206502e5fb38383c8ba",
      measurementId: "G-LNTNZQBGL8"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser;
    let isVendor = false;
    let posts = [];
    let page = 1;
    const pageSize = 10;

    auth.onAuthStateChanged(async user => {
      if (!user) return location.href = 'login.html';
      currentUser = user;

      const userDoc = await db.collection("users").doc(user.uid).get();
      isVendor = userDoc.exists && userDoc.data().accountType === "vendor";

      document.getElementById('dashboardBtn').onclick = () =>
        location.href = isVendor ? 'vendor-dashboard.html' : 'dashboard.html';

      if (isVendor) {
        document.getElementById('postBtnContainer').classList.remove('hidden');
      }

      loadFeed();
      setupFilters();
    });

    function setupFilters() {
      document.getElementById("sortFilter").addEventListener("change", loadFeed);
      document.getElementById("cityFilter").addEventListener("change", loadFeed);
      document.getElementById("prevPage").addEventListener("click", () => {
        if (page > 1) {
          page--;
          renderFeed();
        }
      });
      document.getElementById("nextPage").addEventListener("click", () => {
        if (page * pageSize < posts.length) {
          page++;
          renderFeed();
        }
      });
    }

    function loadFeed() {
      db.collection("posts").onSnapshot(snapshot => {
        posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderFeed();
      });
    }

    function renderFeed() {
      const feed = document.getElementById("feed");
      feed.innerHTML = "";

      const sortBy = document.getElementById("sortFilter").value;
      const city = document.getElementById("cityFilter").value;

      let filtered = [...posts];
      if (city) {
        filtered = filtered.filter(post => post.city === city);
      }

      filtered.sort((a, b) => (b[sortBy] || 0) - (a[sortBy] || 0));

      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      const currentPage = filtered.slice(start, end);

      document.getElementById("pageInfo").innerText = `Page ${page} of ${Math.ceil(filtered.length / pageSize)}`;

      currentPage.forEach(post => {
        const el = document.createElement("div");
        el.className = "bg-white p-4 rounded shadow";
        el.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-lg font-semibold">${post.title}</h2>
              <p class="text-sm text-gray-500">${post.city} ‚Ä¢ ${new Date(post.timestamp?.toDate?.() || Date.now()).toLocaleString()}</p>
              ${post.isVendor ? '<span class="text-xs bg-yellow-500 text-white px-2 py-1 rounded-full">Vendor</span>' : ''}
            </div>
            <button onclick="viewPost('${post.id}')" class="text-blue-600 underline text-sm">View</button>
          </div>
          <p class="mt-2">${post.description || ''}</p>
          <div class="flex justify-between mt-2 text-sm text-gray-600">
            <span>üëç ${post.likes || 0}</span>
            <span>üëÅÔ∏è ${post.views || 0}</span>
          </div>
        `;
        feed.appendChild(el);
      });
    }

    function viewPost(postId) {
      window.location.href = `view-post.html?id=${postId}`;
    }
  </script>
</body>
</html>
