<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Street Link â€” Feed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .skeleton {
      @apply animate-pulse bg-gray-200 h-48 rounded-lg;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <div class="p-4 bg-white shadow flex justify-between items-center">
    <h1 class="text-xl font-bold">Street Link Feed</h1>
    <div>
      <select id="provinceFilter" class="border p-1 rounded">
        <option value="">All Provinces</option>
      </select>
      <select id="cityFilter" class="border p-1 rounded">
        <option value="">All Cities</option>
      </select>
    </div>
  </div>

  <div id="postContainer" class="p-4 space-y-4"></div>

  <div id="pagination" class="flex justify-center mt-6 space-x-2">
    <button id="prevBtn" class="px-4 py-2 bg-gray-200 rounded">Previous</button>
    <button id="nextBtn" class="px-4 py-2 bg-gray-800 text-white rounded">Next</button>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDEsYzVYNvSsKvgFk5cSa_7lWWdJtDc1gs",
      authDomain: "online-mall-4422.firebaseapp.com",
      databaseURL: "https://online-mall-4422-default-rtdb.firebaseio.com",
      projectId: "online-mall-4422",
      storageBucket: "online-mall-4422.appspot.com",
      messagingSenderId: "947082232783",
      appId: "1:947082232783:web:116206502e5fb38383c8ba",
      measurementId: "G-LNTNZQBGL8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    const postContainer = document.getElementById("postContainer");
    const provinceFilter = document.getElementById("provinceFilter");
    const cityFilter = document.getElementById("cityFilter");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    let allPosts = [];
    let filteredPosts = [];
    let currentPage = 1;
    const postsPerPage = 5;

    function showSkeletons() {
      postContainer.innerHTML = "";
      for (let i = 0; i < postsPerPage; i++) {
        const skeleton = document.createElement("div");
        skeleton.className = "skeleton";
        postContainer.appendChild(skeleton);
      }
    }

    function renderPosts() {
      postContainer.innerHTML = "";

      const start = (currentPage - 1) * postsPerPage;
      const end = start + postsPerPage;
      const pagePosts = filteredPosts.slice(start, end);

      if (pagePosts.length === 0) {
        postContainer.innerHTML = "<p>No posts found.</p>";
        return;
      }

      pagePosts.forEach(post => {
        const div = document.createElement("div");
        div.className = "bg-white rounded-lg shadow p-4";

        const imageHTML = post.imageURL
          ? `<img loading="lazy" src="${post.imageURL}" alt="post image" class="w-full max-h-60 object-cover rounded mb-2">`
          : "";

        div.innerHTML = `
          ${imageHTML}
          <h2 class="text-lg font-bold">${post.title}</h2>
          <p class="text-sm text-gray-600">${post.description || ""}</p>
          <div class="mt-2 flex justify-between text-sm">
            <span>Likes: ${post.likes || 0}</span>
            <button class="likeBtn text-blue-600 underline" data-id="${post.id}">Like</button>
          </div>
        `;

        postContainer.appendChild(div);
      });
    }

    async function fetchPosts() {
      showSkeletons();
      const snapshot = await db.collection("posts").orderBy("timestamp", "desc").get();
      allPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      updateFilters();
      applyFilters();
    }

    function updateFilters() {
      const provinces = [...new Set(allPosts.map(p => p.province).filter(Boolean))];
      provinceFilter.innerHTML = `<option value="">All Provinces</option>` +
        provinces.map(p => `<option value="${p}">${p}</option>`).join("");

      const cities = [...new Set(allPosts.map(p => p.city).filter(Boolean))];
      cityFilter.innerHTML = `<option value="">All Cities</option>` +
        cities.map(c => `<option value="${c}">${c}</option>`).join("");
    }

    function applyFilters() {
      const selectedProvince = provinceFilter.value;
      const selectedCity = cityFilter.value;

      filteredPosts = allPosts.filter(post =>
        (!selectedProvince || post.province === selectedProvince) &&
        (!selectedCity || post.city === selectedCity)
      );

      currentPage = 1;
      renderPosts();
    }

    provinceFilter.addEventListener("change", applyFilters);
    cityFilter.addEventListener("change", applyFilters);

    prevBtn.onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        renderPosts();
      }
    };

    nextBtn.onclick = () => {
      if ((currentPage * postsPerPage) < filteredPosts.length) {
        currentPage++;
        renderPosts();
      }
    };

    postContainer.addEventListener("click", async e => {
      if (e.target.classList.contains("likeBtn")) {
        const postId = e.target.getAttribute("data-id");
        const postRef = db.collection("posts").doc(postId);
        await postRef.update({ likes: firebase.firestore.FieldValue.increment(1) });
        fetchPosts(); // Refresh likes
      }
    });

    fetchPosts();
  </script>

</body>
</html>
