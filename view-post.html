<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>View Post</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <nav class="bg-white shadow-md p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Street Link</h1>
    <div>
      <button onclick="location.href='feed.html'" class="px-4 py-2 bg-blue-500 text-white rounded">Back to Feed</button>
    </div>
  </nav>

  <div class="max-w-2xl mx-auto mt-6 bg-white p-6 rounded shadow-md" id="postContainer">
    <h2 class="text-2xl font-bold" id="postTitle">Loading...</h2>
    <p class="text-sm text-gray-600 mb-2" id="postVendor"></p>
    <img id="postImage" class="w-full h-auto rounded mb-4 hidden" />
    <p class="mb-4" id="postContent"></p>
    <div class="flex items-center justify-between text-sm text-gray-500">
      <span id="likesCount">‚ù§Ô∏è 0 Likes</span>
      <span id="viewsCount">üëÅÔ∏è 0 Views</span>
      <span id="avgRating">‚≠ê 0.0 Rating</span>
    </div>

    <div class="mt-4 flex gap-2">
      <button id="likeBtn" class="bg-red-500 text-white px-4 py-1 rounded">Like</button>
      <button id="followBtn" class="bg-green-500 text-white px-4 py-1 rounded">Follow Vendor</button>
      <button onclick="location.href='rate.html?vendorId=' + vendorId" class="bg-yellow-500 text-white px-4 py-1 rounded">Rate</button>
      <button onclick="location.href='inbox.html?vendorId=' + vendorId" class="bg-blue-500 text-white px-4 py-1 rounded">Message</button>
    </div>
  </div>

  <div id="uploadSection" class="max-w-2xl mx-auto mt-10 bg-white p-6 rounded shadow-md hidden">
    <h2 class="text-lg font-bold mb-4">Create New Post</h2>
    <input type="text" id="newTitle" placeholder="Title" class="w-full border p-2 mb-2 rounded"/>
    <textarea id="newContent" placeholder="Content" class="w-full border p-2 mb-2 rounded"></textarea>
    <input type="file" id="newImage" class="mb-2"/>
    <button onclick="uploadPost()" class="bg-blue-600 text-white px-4 py-2 rounded">Upload</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDEsYzVYNvSsKvgFk5cSa_7lWWdJtDc1gs",
      authDomain: "online-mall-4422.firebaseapp.com",
      databaseURL: "https://online-mall-4422-default-rtdb.firebaseio.com",
      projectId: "online-mall-4422",
      storageBucket: "online-mall-4422.appspot.com",
      messagingSenderId: "947082232783",
      appId: "1:947082232783:web:116206502e5fb38383c8ba",
      measurementId: "G-LNTNZQBGL8"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let vendorId = null;

    const postId = new URLSearchParams(window.location.search).get('id');

    auth.onAuthStateChanged(async user => {
      if (!user) return location.href = "login.html";

      const postDoc = await db.collection("posts").doc(postId).get();
      const post = postDoc.data();
      if (!post) return alert("Post not found");

      vendorId = post.vendorId;
      document.getElementById("postTitle").textContent = post.title;
      document.getElementById("postContent").textContent = post.content;
      document.getElementById("postVendor").textContent = "By " + (post.vendorName || "Vendor");

      if (post.imageUrl) {
        const img = document.getElementById("postImage");
        img.src = post.imageUrl;
        img.classList.remove("hidden");
      }

      await db.collection("posts").doc(postId).update({
        views: firebase.firestore.FieldValue.increment(1)
      });

      document.getElementById("viewsCount").textContent = "üëÅÔ∏è " + ((post.views || 0) + 1) + " Views";
      document.getElementById("likesCount").textContent = "‚ù§Ô∏è " + (post.likes || 0) + " Likes";

      // Ratings
      const ratingsSnap = await db.collection("ratings").where("vendorId", "==", vendorId).get();
      const ratings = ratingsSnap.docs.map(d => d.data().rating || 0);
      const avg = ratings.length ? (ratings.reduce((a,b)=>a+b,0)/ratings.length).toFixed(1) : "0.0";
      document.getElementById("avgRating").textContent = `‚≠ê ${avg} Rating`;

      // Like post
      document.getElementById("likeBtn").addEventListener("click", async () => {
        await db.collection("posts").doc(postId).update({
          likes: firebase.firestore.FieldValue.increment(1)
        });
        document.getElementById("likesCount").textContent = "‚ù§Ô∏è " + (post.likes + 1) + " Likes";
      });

      // Follow vendor
      document.getElementById("followBtn").addEventListener("click", async () => {
        const ref = db.collection("follows").doc(`${user.uid}_${vendorId}`);
        await ref.set({ userId: user.uid, vendorId, timestamp: Date.now() });
        alert("Followed vendor");
      });

      // Upload post if user is the vendor
      const userDoc = await db.collection("users").doc(user.uid).get();
      const userData = userDoc.data();
      if (userData && userData.accountType === "vendor" && user.uid === vendorId) {
        document.getElementById("uploadSection").classList.remove("hidden");
      }
    });

    async function uploadPost() {
      const user = auth.currentUser;
      const title = document.getElementById("newTitle").value;
      const content = document.getElementById("newContent").value;
      const imageFile = document.getElementById("newImage").files[0];
      let imageUrl = "";

      if (imageFile) {
        const storageRef = firebase.storage().ref(`posts/${user.uid}_${Date.now()}`);
        await storageRef.put(imageFile);
        imageUrl = await storageRef.getDownloadURL();
      }

      await db.collection("posts").add({
        title, content, imageUrl,
        vendorId: user.uid,
        vendorName: user.displayName || "Vendor",
        timestamp: Date.now(),
        likes: 0,
        views: 0
      });

      alert("Post uploaded!");
      location.reload();
    }
  </script>
</body>
</html>
